<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis - Kemasukan Data Manual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .hidden { display: none; }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .delete-btn {
            background-color: #fee2e2;
            color: #b91c1c;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900">Dashboard Analisis Pencapaian Murid</h1>
            <p class="mt-2 text-lg text-gray-600">Masukkan data murid secara manual untuk menjana analisis.</p>
        </header>

        <!-- Data Entry Section -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Langkah 1: Tambah Data Murid</h2>
            <form id="add-student-form" class="space-y-4">
                <div>
                    <label for="studentName" class="block text-sm font-medium text-gray-700">Nama Penuh Murid</label>
                    <input type="text" id="studentName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div id="subject-inputs" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Subject inputs will be generated here -->
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">Tambah Murid ke Senarai</button>
            </form>
        </div>

        <!-- Student List Table -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Senarai Murid Dimasukkan</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Murid</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purata TP</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body" class="bg-white divide-y divide-gray-200">
                        <tr id="no-student-row">
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Tiada data murid dimasukkan lagi.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Dashboard Content - Hidden until data exists -->
        <div id="dashboard-content" class="hidden">
            <hr class="my-12 border-gray-300 border-dashed">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Langkah 2: Analisis Data</h2>
            <!-- Student Analysis Section -->
            <div class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Analisis Peringkat Murid</h3>
                <div class="card">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                             <label for="student-selector" class="block text-lg font-medium text-gray-700 mb-2">Pilih Murid</label>
                            <select id="student-selector" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-6"></select>
                            <div id="student-summary" class="space-y-4 text-gray-700"></div>
                        </div>
                        <div class="lg:col-span-2">
                             <h3 class="text-xl font-semibold text-gray-800 mb-4">Profil Penguasaan Subjek</h3>
                            <div class="chart-container">
                                <canvas id="student-radar-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Analysis Section -->
            <div class="mb-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Analisis Peringkat Kelas</h3>
                <div class="mb-6 card">
                    <h4 class="text-xl font-semibold text-gray-800 mb-4">Rumusan Keseluruhan Kelas</h4>
                    <div id="overall-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card">
                            <label for="subject-selector" class="block text-lg font-medium text-gray-700 mb-2">Pilih Subjek</label>
                            <select id="subject-selector" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div class="card">
                            <h4 class="text-xl font-semibold text-gray-800 mb-4">Pecahan TP Subjek</h4>
                            <div class="chart-container" style="height:300px">
                                <canvas id="pie-chart"></canvas>
                            </div>
                            <p id="subject-pie-summary" class="text-center mt-4 text-gray-600 text-sm"></p>
                        </div>
                    </div>
                    <div class="lg:col-span-3 card">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Perbandingan Penguasaan Merentas Subjek</h4>
                        <div class="chart-container">
                            <canvas id="bar-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let allData = [];
            let subjects = [
                'Bahasa Melayu', 'Bahasa Inggeris', 'Matematik', 'Sains', 'Sejarah',
                'Pendidikan Islam', 'Pendidikan Seni Visual', 'Pendidikan Muzik', 'Bahasa Arab',
                'Pendidikan Jasmani dan Pendidikan Kesihatan', 'Reka Bentuk dan Teknologi'
            ];
            let pieChart, barChart, radarChart;
            const TP_COLORS = { 'TP1': '#ef4444', 'TP2': '#f97316', 'TP3': '#eab308', 'TP4': '#84cc16', 'TP5': '#22c55e', 'TP6': '#3b82f6', 'N/A': '#9ca3af' };

            // --- ELEMENT SELECTORS ---
            const addStudentForm = document.getElementById('add-student-form');
            const subjectInputsContainer = document.getElementById('subject-inputs');
            const studentListBody = document.getElementById('student-list-body');
            const noStudentRow = document.getElementById('no-student-row');
            const dashboardContent = document.getElementById('dashboard-content');
            const studentSelector = document.getElementById('student-selector');
            const subjectSelector = document.getElementById('subject-selector');

            // --- INITIALIZATION ---
            function generateSubjectInputs() {
                subjectInputsContainer.innerHTML = subjects.map(subject => `
                    <div>
                        <label for="tp-${subject.replace(/\s+/g, '-')}" class="block text-sm font-medium text-gray-700">${subject}</label>
                        <input type="number" id="tp-${subject.replace(/\s+/g, '-')}" data-subject="${subject}" min="1" max="6" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                    </div>
                `).join('');
            }
            generateSubjectInputs();

            // --- EVENT LISTENERS ---
            addStudentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentName = document.getElementById('studentName').value.trim();
                if (!studentName) {
                    alert('Sila masukkan nama murid.');
                    return;
                }

                const newStudent = { 'Nama Murid': studentName, 'Bil': allData.length + 1 };
                let isValid = true;
                subjects.forEach(subject => {
                    const input = document.getElementById(`tp-${subject.replace(/\s+/g, '-')}`);
                    if (input.value) {
                        newStudent[subject] = parseInt(input.value, 10);
                    } else {
                        isValid = false;
                    }
                });

                if (!isValid) {
                    alert('Sila masukkan semua skor TP.');
                    return;
                }
                
                allData.push(newStudent);
                updateStudentList();
                refreshDashboard();
                addStudentForm.reset();
                document.getElementById('studentName').focus();
            });

            studentSelector.addEventListener('change', (event) => updateStudentView(allData[event.target.value]));
            subjectSelector.addEventListener('change', (event) => updatePieChart(event.target.value));

            // --- DATA & UI UPDATES ---
            function updateStudentList() {
                noStudentRow.classList.add('hidden');
                studentListBody.innerHTML = ''; // Clear list
                allData.forEach((student, index) => {
                    const tps = subjects.map(s => student[s]).filter(tp => !isNaN(tp));
                    const average = tps.length > 0 ? (tps.reduce((a, b) => a + b, 0) / tps.length).toFixed(2) : 'N/A';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.Bil}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student['Nama Murid']}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${average}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="delete-btn" data-index="${index}" title="Padam Murid">X</button>
                        </td>
                    `;
                    studentListBody.appendChild(row);
                });

                // Add delete functionality
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.target.dataset.index, 10);
                        allData.splice(indexToRemove, 1);
                        // Re-number students
                        allData.forEach((student, i) => student.Bil = i + 1);
                        
                        updateStudentList();
                        refreshDashboard();
                    });
                });
            }

            function refreshDashboard() {
                if (allData.length > 0) {
                    dashboardContent.classList.remove('hidden');
                    if (pieChart) { // Destroy old charts if they exist
                        pieChart.destroy();
                        barChart.destroy();
                        radarChart.destroy();
                    }
                    initializeDashboard();
                } else {
                    dashboardContent.classList.add('hidden');
                    noStudentRow.classList.remove('hidden');
                }
            }

            // --- ANALYSIS FUNCTIONS (Re-used from previous version) ---
            function initializeDashboard() {
                populateStudentSelector();
                populateSubjectSelector();
                updateOverallSummary();
                createBarChart();
                updatePieChart(subjects[0]);
                updateStudentView(allData[0]);
            }
            
            function populateStudentSelector() {
                studentSelector.innerHTML = allData.map((student, index) => `<option value="${index}">${student.Bil}. ${student['Nama Murid']}</option>`).join('');
            }
            function populateSubjectSelector() {
                subjectSelector.innerHTML = subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('');
            }
            
            function getTpCounts(data, subject) {
                return data.reduce((acc, row) => {
                    const tpKey = `TP${row[subject]?.toString().trim()}` || 'N/A';
                    acc[tpKey] = (acc[tpKey] || 0) + 1;
                    return acc;
                }, { 'TP1': 0, 'TP2': 0, 'TP3': 0, 'TP4': 0, 'TP5': 0, 'TP6': 0, 'N/A': 0 });
            }

            function updatePieChart(subject) {
                const tpCounts = getTpCounts(allData, subject);
                const chartData = {
                    labels: Object.keys(tpCounts).filter(tp => tpCounts[tp] > 0),
                    datasets: [{
                        data: Object.values(tpCounts).filter(count => count > 0),
                        backgroundColor: Object.keys(tpCounts).filter(tp => tpCounts[tp] > 0).map(tp => TP_COLORS[tp] || TP_COLORS['N/A']),
                        borderColor: '#fff', borderWidth: 2
                    }]
                };
                if (pieChart) pieChart.destroy();
                const ctx = document.getElementById('pie-chart').getContext('2d');
                pieChart = new Chart(ctx, { type: 'pie', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } } } } });

                const totalStudents = allData.length;
                const achievedMinimum = totalStudents - (tpCounts['TP1'] + tpCounts['TP2']);
                const percentageAchieved = totalStudents > 0 ? ((achievedMinimum / totalStudents) * 100).toFixed(1) : 0;
                document.getElementById('subject-pie-summary').innerHTML = `Bagi subjek <strong>${subject}</strong>, <strong>${percentageAchieved}%</strong> murid telah mencapai tahap penguasaan minimum (TP3 dan ke atas).`;
            }

            function createBarChart() {
                const tpLevels = ['TP1', 'TP2', 'TP3', 'TP4', 'TP5', 'TP6'];
                const datasets = tpLevels.map(tp => ({
                    label: tp,
                    data: subjects.map(subject => getTpCounts(allData, subject)[tp] || 0),
                    backgroundColor: TP_COLORS[tp],
                }));
                const chartData = {
                    labels: subjects.map(s => s.replace('Pendidikan ', 'P. ').replace('dan Pendidikan Kesihatan', '& PK').replace('Reka Bentuk dan Teknologi', 'RBT')),
                    datasets: datasets
                };
                if (barChart) barChart.destroy();
                const ctx = document.getElementById('bar-chart').getContext('2d');
                barChart = new Chart(ctx, { type: 'bar', data: chartData, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Bilangan Murid' } } } } });
            }
            
            function updateOverallSummary() {
                const summaryContainer = document.getElementById('overall-summary');
                const totalStudents = allData.length;
                const subjectAverages = subjects.map(subject => {
                    const tps = allData.map(row => parseInt(row[subject], 10)).filter(tp => !isNaN(tp));
                    return { subject, average: tps.length > 0 ? tps.reduce((a, b) => a + b, 0) / tps.length : 0 };
                });
                const overallAverage = (subjectAverages.reduce((acc, s) => acc + s.average, 0) / subjectAverages.length).toFixed(2);
                const sortedSubjects = [...subjectAverages].sort((a, b) => b.average - a.average);
                const bestSubject = sortedSubjects[0];
                const worstSubject = sortedSubjects[sortedSubjects.length - 1];
                summaryContainer.innerHTML = [
                    { label: 'Jumlah Murid', value: totalStudents, icon: 'ðŸ‘¥' },
                    { label: 'Purata TP Keseluruhan', value: overallAverage, icon: 'ðŸ“Š' },
                    { label: 'Subjek Prestasi Tertinggi', value: `${bestSubject.subject.split(' ')[0]} (Avg: ${bestSubject.average.toFixed(2)})`, icon: 'ðŸ†' },
                    { label: 'Subjek Perlu Perhatian', value: `${worstSubject.subject.split(' ')[0]} (Avg: ${worstSubject.average.toFixed(2)})`, icon: 'ðŸš©' }
                ].map(item => `<div class="bg-gray-50 p-4 rounded-lg"><div class="text-4xl">${item.icon}</div><p class="text-sm text-gray-500 mt-2">${item.label}</p><p class="text-xl font-bold text-gray-900">${item.value}</p></div>`).join('');
            }

            function updateStudentView(studentData) {
                if (!studentData) return;
                updateStudentRadarChart(studentData);
                updateStudentSummary(studentData);
            }

            function updateStudentRadarChart(studentData) {
                const studentTps = subjects.map(subject => parseInt(studentData[subject], 10) || 0);
                const chartData = {
                    labels: subjects.map(s => s.replace('Pendidikan ', 'P. ').replace('dan Pendidikan Kesihatan', '& PK').replace('Reka Bentuk dan Teknologi', 'RBT')),
                    datasets: [{
                        label: `TP ${studentData['Nama Murid'].split(' ')[0]}`,
                        data: studentTps, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(59, 130, 246)'
                    }]
                };
                if (radarChart) radarChart.destroy();
                const ctx = document.getElementById('student-radar-chart').getContext('2d');
                radarChart = new Chart(ctx, { type: 'radar', data: chartData, options: { responsive: true, maintainAspectRatio: false, elements: { line: { borderWidth: 3 } }, scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 6, pointLabels: { font: {size: 10} } } } } });
            }

            function updateStudentSummary(studentData) {
                const summaryContainer = document.getElementById('student-summary');
                const tps = subjects.map(subject => ({ subject, tp: parseInt(studentData[subject], 10) || 0 }));
                const validTps = tps.filter(item => item.tp > 0);
                if (validTps.length === 0) {
                    summaryContainer.innerHTML = `<p>Tiada data TP untuk murid ini.</p>`; return;
                }
                const average = (validTps.reduce((a, b) => a + b.tp, 0) / validTps.length).toFixed(2);
                const strengths = validTps.filter(s => s.tp >= 5);
                const needsAttention = validTps.filter(s => s.tp < 3);
                summaryContainer.innerHTML = `
                    <p class="text-lg"><span class="font-semibold">Nama Murid:</span><br>${studentData['Nama Murid']}</p>
                    <p><span class="font-semibold">Purata Keseluruhan:</span> <span class="font-bold text-xl text-blue-600">${average}</span></p>
                    <div class="mt-4">
                        <h4 class="font-semibold text-md text-green-600">Kekuatan Utama (TP5 ke atas):</h4>
                        <ul class="list-disc list-inside text-sm summary-list">
                            ${strengths.length > 0 ? strengths.map(s => `<li>${s.subject} (TP${s.tp})</li>`).join('') : '<li>Tiada subjek dengan TP5 ke atas.</li>'}
                        </ul>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-md text-red-600">Aspek Perlu Perhatian (TP di bawah 3):</h4>
                        <ul class="list-disc list-inside text-sm summary-list">
                             ${needsAttention.length > 0 ? needsAttention.map(s => `<li>${s.subject} (TP${s.tp})</li>`).join('') : '<li>Syabas! Semua subjek mencapai tahap penguasaan minimum.</li>'}
                        </ul>
                    </div>
                     <div class="mt-6 p-3 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-md text-blue-800">Cadangan Intervensi:</h4>
                        <p class="text-sm mt-1">
                            ${needsAttention.length > 0 
                                ? `Beri fokus tambahan kepada subjek <strong>${needsAttention.map(s=>s.subject).join(', ')}</strong>. Sediakan latihan topikal dan galakkan pembelajaran bersama rakan yang lebih mahir.`
                                : `Teruskan momentum cemerlang. Galakkan murid untuk meneroka topik lanjutan atau menyertai pertandingan berkaitan subjek kekuatan.`
                            }
                        </p>
                    </div>`;
            }
        });
    </script>
</body>
</html>
